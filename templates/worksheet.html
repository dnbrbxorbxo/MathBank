<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Î©îÏù∏ÌéòÏù¥ÏßÄ</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="static/img/favicon.png" rel="icon">
    <link href="static/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
          rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="static/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="static/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="static/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="static/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="static/vendor/simple-datatables/style.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqtree/1.6.1/jqtree.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqtree/1.6.1/tree.jquery.js"></script>
    <!-- Template Main CSS File -->
    <link href="static/css/style.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jsTree CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css"/>
    <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <style>

        #tree-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        #tree {
            font-size: 14px;
        }

        .jstree-anchor {
            color: #333;
            text-decoration: none;
        }

        .jstree-anchor:hover {
            color: #0056b3;
        }

        .jstree-clicked {
            background: #e9ecef !important;
            border-radius: 4px;
        }

        .jstree-wholerow-clicked {
            background: #e9ecef !important;
        }

        #tree {
            margin-top: 20px;
        }

        .form-container {
            margin-top: 20px;
        }

        .jqtree-title-folder::before {
            content: "üìÅ ";
        }

        .jqtree-title-file::before {
            content: "üìÑ ";
        }

        .edit, .delete {
            margin-left: 10px;
            cursor: pointer;
            color: blue;
        }
    </style>

    <script>
        $(document).ready(function () {
            let papersData = []; // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏÑ§Ï†ïÌïòÏó¨ Ïñ¥ÎîîÏÑúÎÇò Ï†ëÍ∑º Í∞ÄÎä•ÌïòÍ≤å Ìï®

            $('#options-container').hide();
            // ÏóêÎîîÌÑ∞ ÏÑ§Ï†ï
            var quill = new Quill('.quill-editor-full', {
                theme: 'snow'
            });

            $('#paper-question-type').change(function () {
                if ($(this).val() === 'Í∞ùÍ¥ÄÏãù') {
                    $('#options-container').show();
                } else {
                    $('#options-container').hide();
                }
            });

            // Ï¥àÍ∏∞ Î°úÎìúÏãú Ïà®Í∏∞Í∏∞ ÏÑ§Ï†ï
            if ($('#paper-question-type').val() !== 'Í∞ùÍ¥ÄÏãù') {
                $('#options-container').hide();
            }

            // Î¨∏Ï†ú Î™©Î°ù Î∞è Ìä∏Î¶¨ Í∞±Ïã†
            function fetchPapers() {
                $.ajax({
                    type: 'GET',
                    url: '/papers',
                    success: function (papers) {
                        papersData = papers; // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
                        populatePaperTree(papers);
                        populateParentSelect(papers);
                    },
                    error: function (error) {
                        console.error('ÏóêÎü¨:', error);
                    }
                });
            }

            // Ìä∏Î¶¨ Íµ¨Ï°∞ Ï±ÑÏö∞Í∏∞
            function populatePaperTree(papers) {
                var treeData = [{
                    'id': 'root',
                    'parent': '#',
                    'text': 'Î¨∏Ï†ú ÏùÄÌñâ'
                }];

                papers.forEach(function (paper) {
                    if (!paper.parent) {
                        paper.parent = "root";
                    }
                    paper.text = paper.title;
                    console.log(paper.category);
                    if (paper.category === true) {
                        paper.type = 'folder';  // Specify this as a folder
                        treeData.push(paper);
                    }
                });

                console.log(treeData);

                $('#tree').jstree('destroy').empty(); // Ìä∏Î¶¨ Ï¥àÍ∏∞Ìôî
                $('#tree').jstree({
                    'core': {
                        'data': treeData,
                    },
                    'types': {
                        'file': {
                            'icon': "jqtree-title-file"
                        },
                        'folder': {
                            'icon': "jqtree-title-folder"
                        }
                    },
                    'plugins': ['types' , 'checkbox'],
                    'checkbox': {
                        'keep_selected_style': false,
                        'tie_selection': false // ÏÑ†ÌÉùÍ≥º Ï≤¥ÌÅ¨Î∞ïÏä§Î•º Î≥ÑÍ∞úÎ°ú Ïú†ÏßÄ
                    }
                }).bind("loaded.jstree", function (event, data) {
                    data.instance.open_all();  // Ìä∏Î¶¨ Ï¥àÍ∏∞Ìôî Ïãú Î™®Îì† ÎÖ∏ÎìúÎ•º Ïó¥Í∏∞
                });

                // Ìä∏Î¶¨ Ìï≠Î™© ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
                $('#tree').on('select_node.jstree', function (e, data) {
                    var selectedId = data.node.id;
                    if (selectedId !== 'root') {
                        var selectedPaper = papersData.find(paper => paper.id == selectedId);
                        if (selectedPaper) {
                            console.log(selectedPaper)
                            $('#paper-id').val(selectedPaper.id);
                            console.log(selectedPaper.category);
                            if (selectedPaper.category) {
                                $('#paper-category').prop('checked', true);
                            } else {
                                $('#paper-category').prop('checked', false);
                            }
                            $('#paper-parent-id').val(selectedPaper.parent);
                            $('#paper-title').val(selectedPaper.title);

                            quill.root.innerHTML = selectedPaper.description;

                            $('#paper-difficulty').val(selectedPaper.difficulty);
                            $('#paper-question-type').val(selectedPaper.question_type);
                            $('#paper-correct-answer').val(selectedPaper.correct_answer);

                            $('#question_file_down').text(selectedPaper.solution + "[ÎØ∏Î¶¨Î≥¥Í∏∞]");
                            $('#question_file_down').attr("href", "/DownloadPaper/" + selectedPaper.solution);

                            $('#explanation_file_down').text(selectedPaper.solution + "[ÎØ∏Î¶¨Î≥¥Í∏∞]");
                            $('#explanation_file_down').attr("href", "/DownloadPaper/" + selectedPaper.explanation_pdf);
                        }
                    }
                });
            }

            // Î∂ÄÎ™® Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Î∞ïÏä§ Ï±ÑÏö∞Í∏∞
            function populateParentSelect(papers) {
                var $parentSelect = $('#paper-parent-id');
                $parentSelect.empty().append('<option value="">None</option>');
                papers.forEach(function (paper) {
                    $parentSelect.append($('<option>', {
                        value: paper.id,
                        text: paper.title
                    }));
                });
            }

            $("#clear").on("click", function () {
                $('#paper-form input').val("");

                quill.root.innerHTML = "";

                $('#paper-difficulty').val("");
                $('#paper-question-type').val("");
                $('#paper-correct-answer').val("");

                $('#question_file_down').text("");
                $('#question_file_down').attr("href", "#");

                $('#explanation_file_down').text("");
                $('#explanation_file_down').attr("href", "#");


                fetchPapers();
            });

            $('#worksheet-form').on('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission

                // Create a FormData object from the form
                var formData = new FormData(this);

                // Include the description content from the Quill editor
                formData.append('description', quill.root.innerHTML);
                var checkedNodes = $('#tree').jstree('get_checked', true); // Get checked nodes with full objects
                var checkedData = checkedNodes.map(function(node) {
                    return {
                        id: node.id,
                        text: node.text,
                        parent: node.parent
                    };
                });
                var checkedDataJson = JSON.stringify(checkedData);

                formData.append('papers_json', checkedDataJson);


                 $.ajax({
                    url: '/save-worksheet',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,

                    success: function (response) {
                        alert('ÌïôÏäµÏßÄ Ï†ÄÏû• Î∞è ÏÉùÏÑ±Ïóê ÏÑ±Í≥µÌïòÏòÄÏäµÎãàÎã§.');
                        location.reload();

                    },
                    error: function (error) {
                        console.error('Ï†ÄÏû• Ïã§Ìå® :', error);
                        alert('Ï†ÄÏû• Ïã§Ìå®');
                    }
                });
            });

            fetchPapers();

        });

        function rowclick(ele){
            let worksheet = $(ele).attr("data-worksheet");
            console.log(worksheet);


            var iframe = document.getElementById('WorksheetViewer');
            var doc = iframe.contentDocument || iframe.contentWindow.document;

            // Write the HTML content to the iframe's document
            doc.open();
            doc.write(worksheet);
            doc.close();
        }
    </script>


</head>

<body>

<!-- ======= ÌÉë Header ======= -->
<header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
        <a href="/main" class="logo d-flex align-items-center">
            <img src="static/img/logo.png" alt="">
            <span class="d-none d-lg-block">Î¨∏Ï†úÏùÄÌñâ</span>
        </a>
        <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->


    <nav class="header-nav ms-auto">
        <ul class="d-flex align-items-center">

            <li class="nav-item dropdown pe-3">

                <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                    <img src="static/img/userimg.png" alt="Profile" class="rounded-circle">
                    <span class="d-none d-md-block dropdown-toggle ps-2">{{ user.name }}</span>
                </a><!-- End Profile Iamge Icon -->

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                    <li class="dropdown-header">
                        <h6>{{ user.name }}</h6>
                        <span>{{ user.school }}</span>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>

                    <li>
                        <a class="dropdown-item d-flex align-items-center" href="users-profile.html">
                            <i class="bi bi-person"></i>
                            <span>ÎßàÏù¥ÌéòÏù¥ÏßÄ</span>
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>


                    <li>
                        <hr class="dropdown-divider">
                    </li>

                    <li>
                        <a class="dropdown-item d-flex align-items-center" href="/logout">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Î°úÍ∑∏ÏïÑÏõÉ</span>
                        </a>
                    </li>

                </ul><!-- End Profile Dropdown Items -->
            </li><!-- End Profile Nav -->

        </ul>
    </nav><!-- End Icons Navigation -->

</header><!-- End Header -->

<!-- ======= Î©îÎâ¥ Ï†ïÎ≥¥ ======= -->
<aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

        <li class="nav-item">
            <a class="nav-link" href="/main">
                <i class="bi bi-grid"></i>
                <span>Î©îÏù∏</span>
            </a>
        </li>

        <li class="nav-heading">ÌïôÏÉù Î©îÎâ¥</li>

        <li class="nav-item">
            <a class="nav-link collapsed" href="/main">
                <i class="bi bi-person"></i>
                <span>ÎÇòÏùò ÌïôÏäµ Ï†ïÎ≥¥</span>
            </a>
        </li><!-- End Profile Page Nav -->

        <li class="nav-item">
            <a class="nav-link collapsed" href="/main">
                <i class="bi bi-card-list"></i>
                <span>ÌïôÏäµÌïòÍ∏∞</span>
            </a>
        </li><!-- End Register Page Nav -->

        <li class="nav-heading">Í¥ÄÎ¶¨Ïûê Î©îÎâ¥</li>
        <li class="nav-item">
            <a class="nav-link " href="/worksheet">
                <i class="bi bi-gem"></i>
                <span>ÌïôÏäµÏßÄ Í¥ÄÎ¶¨</span>
            </a>
        </li><!-- End Register Page Nav -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="/category">
                <i class="bi bi-menu-button-wide"></i>
                <span>ÌïôÏäµ Î¨∏Ï†ú Í¥ÄÎ¶¨</span>
            </a>
        </li><!-- End Register Page Nav -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="/main">
                <i class="bi bi-journal-text"></i>
                <span>ÌïôÏäµ ÌÜµÍ≥Ñ Ï†ïÎ≥¥</span>
            </a>
        </li><!-- End Register Page Nav -->

        <li class="nav-item">
            <a class="nav-link collapsed" href="/userlist">
                <i class="bi bi-journal-text"></i>
                <span>ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨</span>
            </a>
        </li><!-- End Register Page Nav -->


    </ul>

</aside><!-- End Sidebar-->

<main id="main" class="main">

    <div class="pagetitle">
        <h1>ÌïôÏäµÎ¨∏Ï†ú Í¥ÄÎ¶¨</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Ìôà</a></li>
                <li class="breadcrumb-item active">ÌïôÏäµÏßÄ Í¥ÄÎ¶¨</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->
    <!-- Large Modal -->

    <section class="section dashboard">
        <div class="row">
            <div class="col-lg-6">

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ÌïôÏäµÏßÄ Î¶¨Ïä§Ìä∏

                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" style="float: right;"
                                    data-bs-target="#WorkSheetModal">
                                ÌïôÏäµÏßÄ ÏÑ§Ï†ï
                            </button>
                        </h5>
                        <!-- Table with stripped rows -->
                        <table class="table datatable">
                            <thead>
                            <tr>
                                <th style="text-align: center;">ÏàúÏÑú</th>
                                <th style="text-align: center;">ÌïôÏäµÏßÄÎ™Ö</th>
                                <th style="text-align: center;">Î¨∏Ï†úÏàò</th>
                                <th style="text-align: center;">ÏÉùÏÑ±Ïùº</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for work in worksheet %}
                                <tr onclick = "rowclick(this)" style="cursor: pointer;" data-worksheet = '{{work.pdf_file}}'>
                                    <td style="text-align: center;">{{ work.id }}</td>
                                    <td style="text-align: center;">{{ work.title }}</td>
                                    <td style="text-align: center;">{{ work.option1}} + {{ work.option2 }} + {{ work.option3 }}</td>
                                    <td style="text-align: center;">{{ work.created_at }}</td>

                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <!-- End Table with stripped rows -->

                    </div>
                </div>
            </div>
            <div class="col-lg-6">

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ÌïôÏäµÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞</h5>

                        <iframe id = "WorksheetViewer" style="width: 100%; height: 800px;"></iframe>

                    </div>
                </div>
            </div>

        </div>
    </section>

</main><!-- End #main -->


<div class="modal fade" id="WorkSheetModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ÌïôÏäµÏßÄ ÏÑ§Ï†ï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">

                    <div class="col-lg-6">

                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">ÌïôÏäµÎ¨∏Ï†ú Ìä∏Î¶¨</h5>

                                <div id="tree" style="height: 700px; overflow: auto"></div>

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">ÌïôÏäµÏßÄ ÏÑ§Ï†ï</h5>

                                <div class="form-container">
                                    <form id="worksheet-form">
                                        <input type="hidden" name="id" id="paper-id">

                                        <div class="row mb-3">
                                            <label for="inputText" class="col-sm-2 col-form-label">ÌïôÏäµÏßÄÎ™Ö</label>
                                            <div class="col-sm-10">
                                                <input type="text" name="title" class="form-control" id="paper-title">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="option1" class="col-sm-2 col-form-label">ÏÉÅ </label>
                                            <div class="col-sm-10">
                                                <input type="text" name="option1" class="form-control" id="option1"
                                                       placeholder="ÎÇúÏù¥ÎèÑ(ÏÉÅ) Î¨∏Ï†ú Í∞ØÏàò">
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <label for="option2" class="col-sm-2 col-form-label">Ï§ë</label>
                                            <div class="col-sm-10">
                                                <input type="text" name="option2" class="form-control" id="option2"
                                                       placeholder="ÎÇúÏù¥ÎèÑ(Ï§ë) Î¨∏Ï†ú Í∞ØÏàò">
                                            </div>

                                        </div>

                                        <div class="row mb-3">
                                            <label for="option3" class="col-sm-2 col-form-label">Ìïò</label>
                                            <div class="col-sm-10">
                                                <input type="text" name="option3" class="form-control" id="option3"
                                                       placeholder="ÎÇúÏù¥ÎèÑ(Ìïò) Î¨∏Ï†ú Í∞ØÏàò">
                                            </div>

                                        </div>

                                        <div class="row mb-3">
                                            <label for="option3" class="col-sm-2 col-form-label">Í∞ÄÎ°ú</label>
                                            <div class="col-sm-4">
                                                <input type="text" name="worksheet_col" class="form-control" id="worksheet_col"
                                                       placeholder="Í∞ÄÎ°ú">
                                            </div>

                                            <label for="option3" class="col-sm-2 col-form-label">ÏÑ∏Î°ú</label>
                                            <div class="col-sm-4">
                                                <input type="text" name="worksheet_row" class="form-control" id="worksheet_row"
                                                       placeholder="ÏÑ∏Î°ú">
                                            </div>

                                        </div>


                                        <div class="row mb-3">
                                            <div class="col-sm-12">

                                                <!-- Quill Editor Full -->
                                                <div class="quill-editor-full" style="height: 300px;"
                                                     id="paper-description">
                                                    <p>ÌïôÏäµÏßÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                                                </div>
                                                <!-- End Quill Editor Full -->
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-sm-8">
                                                <button type="submit" class="btn btn-primary" style="width: 100%">Ï†ÄÏû•
                                                </button>
                                            </div>

                                            <div class="col-sm-4">
                                                <button type="button" id="clear" class="btn btn-secondary"
                                                        style="width: 100%">
                                                    Ï¥àÍ∏∞Ìôî
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
            </div>
        </div>
    </div>
</div><!-- End Large Modal-->
<!-- ======= Footer ======= -->
<footer id="footer" class="footer">
    <div class="copyright">
        &copy; Powery by <strong><span>Ïû•ÌòÑÏö∞</span></strong>. All Rights Reserved
    </div>
</footer><!-- End Footer -->

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<!-- Vendor JS Files -->
<script src="static/vendor/apexcharts/apexcharts.min.js"></script>
<script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="static/vendor/chart.js/chart.umd.js"></script>
<script src="static/vendor/echarts/echarts.min.js"></script>
<script src="static/vendor/quill/quill.js"></script>
<script src="static/vendor/simple-datatables/simple-datatables.js"></script>
<script src="static/vendor/tinymce/tinymce.min.js"></script>
<script src="static/vendor/php-email-form/validate.js"></script>

<!-- Template Main JS File -->
<script src="static/js/main.js"></script>

</body>

</html>